/*! sun-rest v0.0.3 by maxaon*/
!function(a){"use strict";var b;a.module("sun.rest.config",[]).provider("RestConfig",function(){var a,b,c,d=!1,e="",f="",g="id",h="PUT",i=!1,j=!0,k=null;c={strictMode:{get:function(){return d},set:function(a){d=a}},baseUrl:{get:function(){return e},set:function(a){a.lastIndexOf("/")===a.length-1&&(a=a.slice(0,-1)),e=a}},responseDataLocation:{get:function(){return f},set:function(a){f=a}},modelIdProperty:{get:function(){return g},set:function(a){g=a}},updateMethod:{get:function(){return h},set:function(a){h=a}},flattenItemRoute:{get:function(){return i},set:function(a){i=a}},requestFormatter:{get:function(){return b},set:function(a){if(!_.isFunction(a))throw new Error("Request formatter must be a function");b=a}},validateOnSync:{get:function(){return j},set:function(a){j=a}},isArray:{get:function(){return k},set:function(a){k=a}},propertyModifier:{get:function(){return a},set:function(b){a=b}}},Object.defineProperties(this,c),this.$get=function(){var a={};return Object.defineProperties(a,_.mapValues(c,function(a){return{get:a.get}})),a}}),b=a.module("sun.rest.manager",["sun.utils","sun.rest.config","sun.rest.router"]),b.factory("ModelManager",["$http","$q","sunUtils","RestConfig","Router",function(b,c,d,e,f){function g(a){return["POST","PUT","PATCH"].indexOf(a.toUpperCase())>-1}function h(a){return null!==a&&""!==a&&"hasOwnProperty"!==a&&k.test("."+a)}function i(a,b){if(!h(b))throw new Error('Dotted member path "@{'+b+'}" is invalid.');var c,d,e,f=b.split(".");for(c=0,d=f.length;d>c&&void 0!==a;c++)e=f[c],a=null!==a?a[e]:void 0;return a}function j(a,b,c){b&&(this.schema=b),c&&(this.modelClass=c),this.remoteFlag=!1,this.modifyFlag=!1,this.model=a,this.originalData={},this.changedProperties={},this.deleteFlag=!1,this.route=new f(this.schema.route)}var k=/^(\.[a-zA-Z_$][0-9a-zA-Z_$]*)+$/;return j.prototype.NEW="new",j.prototype.DELETED="deleted",j.prototype.DIRTY="dirty",j.prototype.LOADED="loaded",j.prototype.NORMALIZE_INCOMING="incoming",j.prototype.NORMALIZE_OUTGOING="outgoing",j.prototype.populate=function(b){var c=this.schema.properties;b=this.normalizeData(b,this.NORMALIZE_INCOMING),a.forEach(b,function(a,b){c[b]&&c[b].toNative&&(a=c[b].toNative(a)),this["__"+b]=a},this.model),this.remoteFlag=!0,this.modifyFlag=!1,this.changedProperties={},this.originalData=b},j.prototype.reset=function(){var a=this.remoteFlag;this.populate(this.originalData),this.remoteFlag=a},j.prototype.toJSON=function(){var a,b={};return _.forEach(this.schema.properties,function(c,d){a=this.model["_"+d],c.toJson&&(a=c.toJson(a)),b[d]=a},this),this.normalizeData(b,this.NORMALIZE_OUTGOING)},j.prototype.normalizeData=function(a,b){var c={},d=b===this.NORMALIZE_OUTGOING;return _.forEach(this.schema.properties,function(b,e){var f=b.remoteProperty?b.remoteProperty:e,g=d?f:e,h=d?e:f;c[g]=a[h]||a[e]}),c},j.prototype.extractParams=function(b,c){var d={};return c=a.extend({},this.schema.paramDefaults,c),a.forEach(c,function(c,e){a.isFunction(c)&&(c=c()),d[e]=c&&c.charAt&&"@"===c.charAt(0)?i(b,c.substr(1)):c}),d},j.prototype.save=function(b,c){var d,f,g=this.state===this.NEW,h=g?"POST":e.updateMethod;return b=a.extend({},this.schema.paramDefaults[g?"create":"update"],b),f=this.simpleRequest(h,b,this.model,this.schema.dataItemLocation),d=this.model,c!==!1&&(f=f.then(function(a){return d.mngr.populate(a),a})),f},j.prototype.remove=function(b){return b=a.extend({},this.schema.paramDefaults.remove,b),this.simpleRequest("DELETE",b)},j.prototype.objectRequest=function(b,e,f,g){var h,i=this.modelClass,j=e===!0?this.schema.dataListLocation:this.schema.dataItemLocation,k=e?[]:new i(g);return h=this.simpleRequest(b,f,g).then(function(b){var c,f,g;return c=b.data,f=k.$promise,c&&(g=d.stringJsonParser(j,c),e?(k.length=0,a.forEach(g,function(a){k.push(new i(a))})):(k.populate(g),k.$promise=f)),k.$resolved=!0,b.resource=k,b},function(a){return k.$resolved=!0,c.reject(a)}),k.$promise=h,k.$resolved=!1,k},j.prototype.simpleRequest=function(c,e,f,h){var i,j={method:c};return g(c)&&(j.data=f),e=e||{},f&&(e[this.schema.idProperty]=f[this.schema.idProperty]),this.route.buildConfig(j,a.extend({},this.extractParams(f),e)),i=b(j),a.isDefined(h)&&(i=i.then(function(a){return d.stringJsonParser(h,a.data)})),i},Object.defineProperties(j.prototype,{state:{get:function(){var a;return a=this.remoteFlag?this.deleteFlag?this.DELETED:this.modifyFlag?this.DIRTY:this.LOADED:this.NEW}},isRemote:{get:function(){return this.remoteFlag&&!this.deleteFlag}}}),j.create=function(a,b,c){var e;return _.isFunction(c)?e=c:(e=function(){this.$super.constructor.apply(this,arguments)},_.isObject(c)&&(e.prototype=c)),d.inherit(e,j),e.prototype.schema=a,e.prototype.modelClass=b,e},j}]),b=a.module("sun.rest.model",["sun.rest.manager","sun.utils"]),b.factory("modelFactory",["sunUtils","ModelManager",function(a,b){function c(a){this.$super.constructor.call(this,a)}function d(d){var f,g={};return f=a.inherit(d.inherit||c,e),_.forEach(d.properties,function(a,b){var c,e,h=!1,i=!1,j=!1;f.prototype[b]?i=h=j=!0:(i=!!d.properties[b].getter,h=!!d.properties[b].setter),g["_"+b]={get:function(){return this["__"+b]},set:function(a){a!==this["__"+b]&&(a===this.mngr.originalData[b]?(delete this.mngr.changedProperties[b],this.mngr.modifyFlag=Object.keys(this.mngr.changedProperties).length>0):(this.mngr.changedProperties[b]=!0,this.mngr.modifyFlag=!0)),this["__"+b]=a}},j||(c=i?function(){return d.properties[b].getter.call(this,this["_"+b])}:function(){return this["_"+b]},e=h?function(a){this["_"+b]=d.properties[b].setter.call(this,a)}:function(a){this["_"+b]=a},g[b]={get:c,set:e})}),Object.defineProperties(f.prototype,g),f.mngrClass=b.create(d,f,f.mngr),f}var e=function(a){this.mngr=new this.constructor.mngrClass(this),_.isEmpty(a)||this.mngr.populate(a)};return e.prototype.constructor=e,e.prototype.toJSON=function(){return this.mngr.toJSON()},e.get=function(a,b){var c=this.mngr.schema.route.match(/:\w[\w0-9-_]*/g);return b=b||{},b[c[c.length-1]]=a,this.mngr.objectRequest("GET",!1,b)},e.query=function(a){return this.mngr.objectRequest("GET",!0,a)},e.fetch=e.query,d.BaseModel=e,d}]),b=a.module("sun.rest",["sun.utils","sun.rest.config","sun.rest.model","sun.rest.router"]),b.factory("RestRepository",["$q","$http","sunUtils","RestConfig","modelFactory","Router",function(b,c,d,e,f,g){function h(b){if(this.properties={},a.extend(this,{name:null,route:null,idProperty:e.modelIdProperty,routeIdProperty:null,properties:{},relations:{},dataListLocation:e.responseDataLocation,dataItemLocation:e.responseDataLocation,autoParse:!0,requestFormatter:e.requestFormatter,isArray:e.isArray,flattenItemRoute:e.flattenItemRoute,modal:{},inherit:null,paramDefaults:{},propertyModifier:e.propertyModifier},b),!this.routeIdProperty){var c=this.route.match(/:\w[\w0-9-_]*/g);this.routeIdProperty=c[c.length-1].slice(1)}if(this.propertyModifier){var d,f=this.propertyModifier;_.forEach(this.properties,function(a,b){d=f(a,b),d&&(this[b]=d)},this.properties)}}var i=function(a){this.schema=a,this.router=new g(a.route),this.model=f(a)};return i.prototype.find=function(e,f){var g,h,i,j,k,l=this.model,m=f?"POST":"GET",n=!0;return e=e||{},!_.isObject(e)&&a.isDefined(e)&&(h=e,e={},e[this.schema.routeIdProperty]=h),_.isObject(e)&&e[this.schema.routeIdProperty]&&(n=!1),k=n===!0?this.schema.dataListLocation:this.schema.dataItemLocation,j=n?[]:new l,i={method:m,data:f},this.router.buildConfig(i,e),g=c(i).then(function(b){var c,e=b.data,f=j.$promise;return e&&(c=d.stringJsonParser(k,e),n?(j.length=0,a.forEach(c,function(a){j.push(new l(a))})):(j.mngr.populate(c),j.$promise=f)),j.$resolved=!0,b.resource=j,b},function(a){return j.$resolved=!0,b.reject(a)}),j.$promise=g,j.$resolved=!1,j},{resources:{},create:function(a,b){if(!b){if(!_.isObject(a))throw new Error("Wrong repository call format");b=a}return a=b[a],b=new h(b),this.resources[a]=new i(b),this.resources[a]},get:function(a){return this.resources[a]}}}]),b=a.module("sun.rest.router",["sun.rest.config"]),b.factory("Router",["RestConfig",function(b){function c(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")}function d(a){return c(a,!0).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")}function e(a,b){this.template=a,this.defaults=b||{},this.urlParams={}}return e.prototype={buildConfig:function(c,e,f){e=e||{},f=f||e.url,delete e.url;var g,h,i,j={};return f&&0===f.indexOf("^")?g=f.slice(1):(g=this.template,f&&0!==f.indexOf("/")?g=this.template+"/"+f:f&&(g=f),g=b.baseUrl+g),a.forEach(g.split(/\W/),function(a){if("hasOwnProperty"===a)throw new Error("hasOwnProperty is not a valid parameter name.");!new RegExp("^\\d+$").test(a)&&a&&new RegExp("(^|[^\\\\]):"+a+"(\\W|$)").test(g)&&(j[a]=!0)}),e=e||{},a.forEach(j,function(b,c){h=e.hasOwnProperty(c)?e[c]:this.defaults[c],a.isDefined(h)&&null!==h?(i=d(h),g=g.replace(new RegExp(":"+c+"(\\W|$)","g"),i+"$1")):g=g.replace(new RegExp("(/?):"+c+"(\\W|$)","g"),function(a,b,c){return"/"===c.charAt(0)?c:b+c})},this),g=g.replace(/\/+$/,"")||"/",g=g.replace(/\/\.(?=\w+($|\?))/,"."),c.url=g.replace(/\/\\\./,"/."),a.forEach(e,function(a,b){j[b]||(c.params=c.params||{},c.params[b]=a)}),c}},e}]),a.module("sun.utils",[]).service("sunUtils",function(){this.copyProperties=function(a,b,c){var d,e,f,g;for(c=c||[],e=Object.getOwnPropertyNames(a),d=0;d<e.length;d++)f=e[d],g=Object.getOwnPropertyDescriptor(a,f),-1===c.indexOf(f)&&Object.defineProperty(b,f,g)},this.inherit=function(a,b){var c,d;return c=function(){},c.prototype=b.prototype,d=new c,this.copyProperties(a.prototype,d,["constructor"]),a.prototype=d,a.prototype.constructor=a,a.prototype.$super=b.prototype,a},this.stringJsonParser=function(a,b){var c,d,e=b;if(a.length>0)for(e=b,c=a.split("."),d=0;d<c.length;d+=1)e=_.isObject(e)?e[c[d]]:void 0;return e}})}(angular);
//# sourceMappingURL=dist/sun-rest.min.js.map