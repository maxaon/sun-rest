/*! sun-rest v0.0.5 by maxaon*/
!function(a,b){"use strict";a.module("sun.utils",[]).service("sunUtils",function(){this.copyProperties=function(a,b,c){var d,e,f,g;for(c=c||[],e=Object.getOwnPropertyNames(a),d=0;d<e.length;d++)f=e[d],g=Object.getOwnPropertyDescriptor(a,f),-1===c.indexOf(f)&&Object.defineProperty(b,f,g)},this.inherit=function(b,c){if(!a.isFunction(b)){var d=function(){this.$super.constructor.apply(this,arguments)};return d.prototype=b,this.inherit(d,c)}var e,f;return e=function(){},e.prototype=c.prototype,f=new e,this.copyProperties(b.prototype,f,["constructor"]),b.prototype=f,b.prototype.constructor=b,b.prototype.$super=c.prototype,b},this.stringJsonParser=function(a,c){var d,e,f=c;if(a.length>0)for(f=c,d=a.split("."),e=0;e<d.length;e+=1)f=_.isObject(f)?f[d[e]]:b;return f}});{var c=a.module("sun.rest",["sun.utils"]);a.isDefined,a.isFunction,a.isString,a.isObject,a.isArray,a.forEach,a.extend,a.copy}c.provider("sunRestConfig",function(){var a,b,c,d,e,f,g,h="",i="",j="",k="id",l="PUT",m=!1,n=!1;f={baseUrl:{get:function(){return h},set:function(a){"/"===a[a.length-1]&&(a=a.slice(0,-1)),h=a}},trailingSlashes:{get:function(){return n},set:function(a){n=bool(a)}},responseDataListLocation:{get:function(){return i},set:function(a){i=a}},responseDataItemLocation:{get:function(){return j},set:function(a){j=a}},modelIdProperty:{get:function(){return k},set:function(a){k=a}},updateMethod:{get:function(){return l},set:function(a){l=a}},updatePartial:{get:function(){return m},set:function(a){m=a}},requestInterceptor:{get:function(){return b},set:function(a){if(!_.isFunction(a))throw new Error("Request formatter must be a function");b=a}},requestErrorInterceptor:{get:function(){return c},set:function(a){if(!_.isFunction(a))throw new Error("Request formatter must be a function");c=a}},responseInterceptor:{get:function(){return d},set:function(a){if(!_.isFunction(a))throw new Error("Request formatter must be a function");d=a}},responseErrorInterceptor:{get:function(){return e},set:function(a){if(!_.isFunction(a))throw new Error("Request formatter must be a function");e=a}},propertyModifier:{get:function(){return a},set:function(b){a=b}},dataExtractor:{get:function(){return g},set:function(a){if(!_.isFunction(a))throw new Error("DataExtractor must be a function");g=a}}},Object.defineProperties(this,f),this.$get=function(){return Object.defineProperties({},_.mapValues(f,function(a){return{get:a.get}}))}}),c.factory("sunRestSchema",["$q","sunUtils","sunRestConfig","sunRestRouter",function(c,d,e,f){function g(b){if(a.extend(this,this.defaultProperties,b),!this.route)throw new Error("Schema does not have route property");this.routeIdProperty||(this.routeIdProperty=this.extractRouteIdProperty(this.route)),this.propertyModifier&&this.applyPropertyModifier(this.properties,this.propertyModifier),this.router=new f(this.route)}return g.prototype.defaultProperties={name:null,route:null,router:null,routeIdProperty:null,properties:{},relations:{},dataListLocation:e.responseDataListLocation,dataItemLocation:e.responseDataItemLocation,autoParse:!0,requestInterceptor:e.requestInterceptor,responseInterceptor:e.responseInterceptor,isArray:e.isArray,paramDefaults:{},propertyModifier:e.propertyModifier,dataExtractor:e.dataExtractor},g.prototype.extractRouteIdProperty=function(a){var b=a.match(/:\w[\w0-9-_]*/g);return null===b||0===b.length?null:b[b.length-1].slice(1)},g.prototype.applyPropertyModifier=function(a,c){var d;_.forEach(a,function(e,f){d=c(e,f),d!==b&&(a[f]=d)})},g.prototype.wrappedRequestInterceptor=function(a,b){var d=this.requestInterceptor&&this.requestInterceptor.call(a,b);return c.when(d?d:b)},g.prototype.wrappedResponseInterceptor=function(a,b,d){var e=this.responseInterceptor&&this.responseInterceptor.call(a,b,d);return c.when(e?e:b)},g.defaultDataExtractor=function(a,b){return d.stringJsonParser(a,b.data)},Object.defineProperties(g.prototype,{dataExtractor:{get:function(){return this._dataExtractor||g.defaultDataExtractor},set:function(a){this._dataExtractor=a}}}),g}]),c.factory("sunRestRouter",["sunRestConfig",function(b){function c(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")}function d(a){return c(a,!0).replace(/%26/gi,"&").replace(/%3D/gi,"=").replace(/%2B/gi,"+")}function e(a,b){a&&"/"===a[a.length-1]&&(a=a.slice(0,-1)),this.template=a,this.defaults=b||{},this.urlParams={}}return e.prototype.generateUrl=function(a,c){var d;return d=this._normalizeUrl(a),d=this._injectParams(d,c),b.trailingSlashes===!1&&(d=d.slice(0,d.length-1)),d=d.replace(/\/\.(?=\w+($|\?))/,"."),d=d.replace(/\/\\\./,"/.")},e.prototype.buildConfig=function(b,c,d){var e;return c=c||{},b=b||{},c.url&&(d=c.url,delete c.url),b.url=this.generateUrl(d,c),e=this._extractUrlParams(this._normalizeUrl(d)),a.forEach(c,function(a,c){e[c]||(b.params=b.params||{},b.params[c]=a)}),b},e.prototype._extractUrlParams=function(b){var c={};return a.forEach(b.split(/\W/),function(a){if("hasOwnProperty"===a)throw new Error("hasOwnProperty is not a valid parameter name.");!new RegExp("^\\d+$").test(a)&&a&&new RegExp("(^|[^\\\\]):"+a+"(\\W|$)").test(b)&&(c[a]=!0)}),c},e.prototype._getBaseUrl=function(){return b.baseUrl},e.prototype._prependBaseUrl=function(a){return"/"===a[0]?a=this._getBaseUrl()+a+"/":a+="/",a},e.prototype._normalizeUrl=function(a){var b;return a&&0===a.indexOf("^")?b=a.slice(1):(b=this.template,a&&("/"===a[a.length-1]&&1!==a.length&&(a=a.slice(0,-1)),b="/"===a[0]?a:this.template+"/"+a),b=this._prependBaseUrl(b)),0===b.length&&(b="/"),"/"!==b[b.length-1]&&(b+="/"),b},e.prototype._injectParams=function(b,c){var e,f,g,h=this._extractUrlParams(b);return c=c||{},g=_.isFunction(this.defaults)?this.defaults():this.defaults,a.forEach(h,function(h,i){e=c.hasOwnProperty(i)?c[i]:g[i],a.isDefined(e)&&null!==e?(f=d(e),b=b.replace(new RegExp(":"+i+"(\\W|$)","g"),f+"$1")):b=b.replace(new RegExp("(/?):"+i+"(\\W|$)","g"),function(a,b,c){return"/"===c.charAt(0)?c:b+c})},this),b},e}]),c.factory("sunRestRouterNested",["sunRestConfig","sunRestRouter","sunUtils",function(a,b,c){function d(a,b,c,d){this.$super.constructor.call(this,c,d),this.parentRouter=Object.create(a),this.parentRouter.defaults=Object.create(b),this.parentRouter._getBaseUrl=function(){return""}}return c.inherit(d,b),d.prototype._prependBaseUrl=function(a){var b=this.parentRouter.generateUrl();return b=b.replace(/.:+/g,function(a){return"\\"===a[0]?a:a[0]+Array(a.length).join("\\:")}),this._getBaseUrl()+b+a+"/"},d.prototype.generateUrl=function(a){return a=this.$super.generateUrl.apply(this,arguments),a=a.replace(/\\:/g,":")},d}]),c.factory("sunRestRepository",["sunRestSchema","sunRestCollection",function(a,b){return{resources:{},create:function(c,d){if(!d){if(!_.isObject(c))throw new Error("Wrong repository call format");d=c}return c=d.name,d=new a(d),this.resources[c]=new b(d),this.resources[c]},get:function(a){return this.resources[a]}}}]),c.factory("sunRestBaseModel",function(){var a=function(a){if(!this.schema)throw new Error("Model must be created through ModelFactory");Object.defineProperty(this,"mngr",{value:new this.mngrClass(this),enumerable:!1}),this.mngr.setDefaults(),_.isEmpty(a)||_.extend(this,a)};return a.prototype.constructor=a,a.prototype.mngrClass=b,a.prototype.toJSON=function(){return this.mngr.toJSON()},a}),c.factory("sunRestModelManager",["$http","$q","$injector","sunUtils","sunRestConfig","sunRestRouter",function(c,d,e,f,g){function h(a){return["POST","PUT","PATCH"].indexOf(a.toUpperCase())>-1}function i(a){return null!==a&&""!==a&&"hasOwnProperty"!==a&&m.test("."+a)}function j(a,c){if(!i(c))throw new Error('Dotted member path "@{'+c+'}" is invalid.');var d,e,f,g=c.split(".");for(d=0,e=g.length;e>d&&a!==b;d++)f=g[d],a=null!==a?a[f]:b;return a}function k(a){var b;if(a.service){if(b=e.get(a.service),!b)throw new Error('Unable to get service "'+a.service+'"')}else if(b=e.get("sunRestRepository").get(a.resource),!b)throw new Error('Unable to get resource "'+a.resource+'"');return b}function l(a){if(!this.schema)throw new Error("Mngr must be contain schema");Object.defineProperty(this,"model",{value:a,enumerable:!1}),this.remoteFlag=!1,this.modifyFlag=!1,this.originalData={},this.changedProperties={},this.deleteFlag=!1,this.populating=!1,this.updateRelations()}var m=/^(\.[a-zA-Z_$][0-9a-zA-Z_$]*)+$/;return l.prototype.NEW="new",l.prototype.DELETED="deleted",l.prototype.DIRTY="dirty",l.prototype.LOADED="loaded",l.prototype.NORMALIZE_INCOMING="incoming",l.prototype.NORMALIZE_OUTGOING="outgoing",l.prototype.schema=b,l.prototype.populate=function(b){var c=this.schema.properties;this.populating=!0,b=this.normalizeData(b,this.NORMALIZE_INCOMING),a.forEach(b,function(a,b){c[b]&&c[b].toNative&&(a=c[b].toNative.call(this,a)),this[b]=a},this.model),this.populating=!1,this.remoteFlag=!0,this.modifyFlag=!1,this.changedProperties={}},l.prototype.setDefaults=function(){this.populating=!0,_.forEach(this.schema.properties,function(a,c){var d=a["default"];d!==b&&(d=_.isFunction(d)?new d:_.cloneDeep(d),this.model[c]=d)},this),this.populating=!1},l.prototype.reset=function(){var a=this.remoteFlag;this.populate(this.originalData),this.remoteFlag=a},l.prototype.toJSON=function(){var a,b={};return _.forEach(this.schema.properties,function(c,d){a=this.model["_"+d],c.toJson&&(a=c.toJson(a)),b[d]=a},this),this.normalizeData(b,this.NORMALIZE_OUTGOING)},l.prototype.normalizeData=function(a,b){var c={},d=b===this.NORMALIZE_OUTGOING;return a?(_.forEach(this.schema.properties,function(b,e){var f=b.remoteProperty?b.remoteProperty:e,g=d?f:e,h=d?e:f;a.hasOwnProperty(h)?c[g]=a[h]:a.hasOwnProperty(e)&&(c[g]=a[e])}),c):{}},l.prototype.extractParams=function(b,c){var d={};return c=a.extend({},this.schema.paramDefaults,c),a.forEach(c,function(c,e){a.isFunction(c)&&(c=c()),d[e]=c&&c.charAt&&"@"===c.charAt(0)?j(b,c.substr(1)):c}),d},l.prototype.save=function(b,c){var d,e=this,f=this.state===this.NEW,h=f?"POST":g.updateMethod;return b=a.extend({},this.schema.paramDefaults[f?"create":"update"],b),d=this.simpleRequest(h,b,this.model),c!==!1&&(d=d.then(function(a){var b=e.schema.dataExtractor(e.schema.dataItemLocation,a);return e.populate(b),a})),d},l.prototype.remove=function(b){return b=a.extend({},this.schema.paramDefaults.remove,b),this.simpleRequest("DELETE",b,this.model)},l.prototype.objectRequest=function(a,b,c){var e=this;return this.simpleRequest(a,b,c).then(function(a){if(a.data){var b=e.schema.dataExtractor(e.schema.dataItemLocation,a);e.populate(b)}return a.resource=e.model,a},function(a){return d.reject(a)})},l.prototype.simpleRequest=function(b,d,e){var f,g={method:b},i=this.schema,j=this;return h(b)&&(g.data=e),d=d||{},e&&(d[this.schema.routeIdProperty]=e[this.schema.routeIdProperty]),this.schema.router.buildConfig(g,a.extend({},this.extractParams(e),d)),f=this.schema.wrappedRequestInterceptor(this,g).then(function(a){return c(a)}).then(function(a){return a.resource=j.model,i.wrappedResponseInterceptor(j,a)})},l.prototype.populateRelated=function(a){var b=this;a=a||_.keys(this.schema.relations);var c=_(a).map(function(c,d){var e=_.isArray(a)?{}:d;return b.related[c].request(e).$promise.then(function(a){return b.model[c]=a.resource,a})}).value();return d.all(c)},l.prototype.updateRelations=function(){var a=this;if(a.schema.relations){var b={};_.forEach(a.schema.relations,function(c,d){if(!c.service&&!c.resource)throw new Error("Inappropriate configuration of related item. Resource or service should be speccified");if(c.isArray)throw new Error("Not implemented to get arrays");var f=e.get("sunRestNestedModelManager");b[d]=f.create(a.schema,a.model,k(c))}),this.related=b}},Object.defineProperties(l.prototype,{state:{get:function(){var a;return a=this.remoteFlag?this.deleteFlag?this.DELETED:this.modifyFlag?this.DIRTY:this.LOADED:this.NEW}},isRemote:{get:function(){return this.remoteFlag&&!this.deleteFlag}}}),l.create=function(a,b){var c;return _.isFunction(b)?c=b:(c=function(){this.$super.constructor.apply(this,arguments)},_.isObject(b)&&(c.prototype=b)),f.inherit(c,l),c},l}]),c.factory("sunRestNestedModelManager",["$http","$q","$injector","sunUtils","sunRestConfig","sunRestRouter","sunRestModelManager","sunRestRouterNested",function(a,b,c,d,e,f,g,h){var i=function(){};return i.create=function(a,b,c){var d=function(){var c=this.schema=Object.create(this.schema);this.schema.router=new h(a.router,b,this.schema.router.template,this.schema.router.defaults);var d=this.schema.modelClass,e=function(){this.schema=c;var a=this.mngrClass;this.mngrClass=function(){this.schema=c,a.apply(this,arguments)},this.mngrClass.prototype=Object.create(a.prototype),d.apply(this,arguments)};e.prototype=d.prototype,this.schema.modelClass=e};return d.prototype=c,new d},i}]),c.factory("sunRestModelFactory",["sunUtils","sunRestBaseModel","sunRestModelManager",function(a,c,d){function e(e){var f,g={};return f=a.inherit(e.inherit||{},c),_.forEach(e.properties,function(a,c){var d=!1,h=!1,i=!1,j={enumerable:!0};f.prototype[c]?h=d=i=!0:(h=!!a.getter,d=!!a.setter),g["_"+c]={get:function(){return this["__"+c]},set:function(a){a===this["__"+c]||this.mngr.populating||(a===this.mngr.originalData[c]?(delete this.mngr.changedProperties[c],this.mngr.modifyFlag=Object.keys(this.mngr.changedProperties).length>0):(this.mngr.changedProperties[c]=!0,this.mngr.modifyFlag=!0)),this.mngr.populating&&(this.mngr.originalData=a),this["__"+c]=a}},i||(null!==a.getter&&(j.get=h?function(){return e.properties[c].getter.call(this,this["_"+c])}:function(){return this["_"+c]}),null!==a.setter&&(j.set=d?function(a){var d=e.properties[c].setter.call(this,a);d!==b&&(this["_"+c]=d)}:function(a){this["_"+c]=a}),(j.set||j.get)&&(g[c]=j))}),Object.defineProperties(f.prototype,g),f.prototype.schema=e,f.prototype.mngrClass=d.create(e,f.mngr),f.prototype.mngrClass.prototype.schema=e,f}return e}]),c.factory("sunRestCollection",["$q","$http","sunUtils","sunRestConfig","sunRestModelFactory","sunRestModelManager",function(c,d,e,f,g){function h(a,b){return _.isBoolean(a)&&(a={isArray:a}),a=a||{},_.defaults(a,b)}function i(a,b,c){a=_.bind(a,b);for(var d in c)c.hasOwnProperty(d)&&(a[d]=_.bind(c[d],b));return a}var j=function(a){this.schema=a,this.schema.modelClass=g(a),this.find=i(this.find,this,this.find),this.query=i(this.query,this,this.query)};return j.prototype.find=function(a,b){return b=h(b,{method:"GET",params:a}),this.request(b)},j.prototype.find.one=function(a,b){return b=h(b,{isArray:!1}),this.find(a,b)},j.prototype.find.all=function(a,b,c){return c=h(c,{isArray:!0}),this.find(b,c)},j.prototype.query=function(a,b,c){return c=h(c,{method:"POST",data:a,params:b}),this.request(c)},j.prototype.query.one=function(a,b,c){return c=h(c,{isArray:!1}),this.query(a,b,c)},j.prototype.query.all=function(a,b,c){return c=h(c,{isArray:!0}),this.query(a,b,c)},j.prototype.request=function(f){f=f||{};var g,h,i,j,k,l=this.schema.modelClass,m=this.schema,n=f.method?f.method:f.data?"POST":"GET",o=this,p=f.data,q=f.params,r=f.isArray;return!_.isObject(q)&&a.isDefined(q)&&(h=q,q={},q[this.schema.routeIdProperty]=h),r===b&&(r=!(_.isObject(q)&&q[this.schema.routeIdProperty])),k=r===!0?this.schema.dataListLocation:this.schema.dataItemLocation,j=r?[]:new l,i=this.schema.router.buildConfig({method:n,data:p},q),g=this.schema.wrappedRequestInterceptor(this,i).then(function(a){return d(a)}).then(function(a){return m.wrappedResponseInterceptor(o,a)}).then(function(b){var c,d=b.data,f=j.$promise;return d&&(c=e.stringJsonParser(k,d),r?(j.length=0,a.forEach(c,function(a){var b=new l;b.mngr.populate(a),j.push(b)})):(j.mngr.populate(c),j.$promise=f)),j.$resolved=!0,b.resource=j,b},function(a){return j.$resolved=!0,c.reject(a)}),f.populateRelated&&(g=g.then(function(a){var d=_(r?a.resource:[a.resource]).map(function(a){return a.mngr.populateRelated(_.isBoolean(f.populateRelated)?b:f.populateRelated)}).value();return c.all(d).then(function(){return a})})),j.$promise=g,j.$resolved=!1,j},j.prototype.create=function(a){return new this.schema.modelClass(a)},Object.defineProperty(j.prototype,"model",{get:function(){return this.schema.modelClass}}),j}])}(angular);
//# sourceMappingURL=dist/sun-rest.min.js.map